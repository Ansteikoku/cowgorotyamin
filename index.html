<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>2ch風掲示板（認証 + RLS + 画像検査ワーカー構成）</title>
<style>
 body { font-family: sans-serif; background:#eef2e2; margin:0; padding:0; }
 header { background:#2f4f2f; color:white; padding:10px; text-align:center; }
 .board-list, .thread-list, .post-list { max-width:800px; margin:20px auto; padding:15px; background:white; border-radius:10px; }
 .tabbar { position:fixed; bottom:0; left:0; right:0; background:#2f4f2f; color:white; display:flex; justify-content:space-around; padding:10px; }
 .tabbar button { background:none; border:none; color:white; font-size:16px; }
 .card { margin-top:20px; padding:10px; background:#f8fff0; border-radius:6px; }
 .post-img { max-width:100%; border:1px solid #ccc; margin-top:5px; }
 textarea, input { width:100%; padding:8px; margin:5px 0; }
 button { padding:10px 15px; background:#2f4f2f; color:white; border:none; border-radius:6px; }
</style>
</head>
<body>
<header><h2>2ch風掲示板</h2></header>
<div id="app">
  <div class="board-list" id="board-list"></div>
  <div class="thread-list" id="thread-list" style="display:none"></div>
  <div class="post-list" id="post-list" style="display:none"></div>
</div>
<div class="tabbar">
  <button onclick="showBoards()">板</button>
  <button onclick="showThreads()">スレ</button>
  <button onclick="scrollToBottom()">↓</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase
const supabase = window.supabase.createClient("https://spjepboucvocedgoxzwg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwamVwYm91Y3ZvY2VkZ294endnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTMwMDEsImV4cCI6MjA3OTU2OTAwMX0.nmDF_BRiaXxTV2ij2ak4Fg24iCfHkvAbL7zNDbKCKWU");

// XSS 防止
function clean(text){
  return text.replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

// UI 切替
type = { boards: 'boards', threads:'threads', posts:'posts' }
let currentBoard = null;
let currentThread = null;

function showBoards(){
  document.getElementById('board-list').style.display='block';
  document.getElementById('thread-list').style.display='none';
  document.getElementById('post-list').style.display='none';
}
function showThreads(){
  if(!currentBoard) return alert("板を選んでください");
  document.getElementById('board-list').style.display='none';
  document.getElementById('thread-list').style.display='block';
  document.getElementById('post-list').style.display='none';
}
function showPosts(){
  document.getElementById('board-list').style.display='none';
  document.getElementById('thread-list').style.display='none';
  document.getElementById('post-list').style.display='block';
}
function scrollToBottom(){ window.scrollTo(0, document.body.scrollHeight); }

// 板読み込み
async function loadBoards(){
  const { data } = await supabase.from('boards').select('*');
  const area = document.getElementById('board-list');
  area.innerHTML = `<h3>板一覧</h3>` + data.map(b=>`
    <div class='card' onclick="selectBoard('${b.id}')">
      <b>${clean(b.name)}</b><br>${clean(b.description)}
    </div>`).join('');
}

async function selectBoard(id){ currentBoard=id; loadThreads(); showThreads(); }

// スレ一覧
async function loadThreads(){
  const { data } = await supabase.from('threads').select('*').eq('board_id', currentBoard);
  const area = document.getElementById('thread-list');
  area.innerHTML = `<h3>スレ一覧</h3>` + data.map(t=>`
    <div class='card' onclick="selectThread('${t.id}')">
      <b>${clean(t.title)}</b><br>勢い: ${t.speed || 0}
    </div>`).join('') + `
    <div class='card'>
      <h4>新規スレ作成</h4>
      <form onsubmit="createThread(event)">
        <input id="thread-title" placeholder="スレタイ" required>
        <button>作成</button>
      </form>
    </div>`;
}

async function createThread(e){
  e.preventDefault();
  const title = document.getElementById('thread-title').value;
  await supabase.from('threads').insert({ title, board_id: currentBoard });
  loadThreads();
}

async function selectThread(id){ currentThread=id; loadPosts(); showPosts(); }

// 画像圧縮
function compressImage(file){
  return new Promise(res=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => { img.src=e.target.result; };
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 900;
      let w = img.width, h = img.height;
      if(w>max){ h *= max/w; w=max; }
      canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      res(canvas.toDataURL('image/jpeg',0.65));
    };
    reader.readAsDataURL(file);
  });
}

// 投稿読み込み
async function loadPosts(){
  const { data } = await supabase.from('posts').select('*').eq('thread_id', currentThread).order('created_at');
  const area = document.getElementById('post-list');
  area.innerHTML = `<h3>レス一覧</h3>` + data.map((p,i)=>`
    <div class='card'>
      <b>${i+1} 名前：${clean(p.author)} [ID:${p.uid_hash}]</b><br>
      ${clean(p.body)}
      ${p.image_url ? `<img class='post-img' src="${p.image_url}">` : ''}
    </div>`).join('') + `
    <div class='card'>
      <h4>レス投稿</h4>
      <form onsubmit="createPost(event)">
        <input id="post-author" placeholder="名前">
        <textarea id="post-body" placeholder="本文" required></textarea>
        <input type="file" id="post-image" accept="image/*">
        <button>投稿</button>
      </form>
    </div>`;
  scrollToBottom();
}

// レス投稿
async function createPost(e){
  e.preventDefault();
  const author = document.getElementById('post-author').value || '名無し';
  const body = document.getElementById('post-body').value;
  const file = document.getElementById('post-image').files[0];
  let image_url = null;
  if(file){ image_url = await compressImage(file); }
  await supabase.from('posts').insert({ author, body, thread_id: currentThread, image_url });
  loadPosts();
}

loadBoards();
</script>
</body>
</html>
