<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>グロチャ民の掲示板</title>

<style>
  :root{
    --bg:#001f00; --panel:#042b01; --text:#dfffe0; --muted:#9fd19f;
    --accent:#00ff66; --border:#0a5b12; --radius:12px;
  }
  body{margin:0;background:linear-gradient(#061b06,#000f00);color:var(--text);
       font-family:"Noto Sans JP",sans-serif;}
  .wrap{max-width:1100px;margin:10px auto;padding:10px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .logo{font-weight:800;color:var(--accent);font-size:20px}

  /* --- BOARD LIST --- */
  .board-list{display:flex;flex-direction:column;gap:10px}
  .board-item{
    background:#041c04;border:1px solid var(--border);
    padding:12px;border-radius:var(--radius);cursor:pointer;
  }
  .board-item:hover{background:#062d06}
  .board-title{font-size:17px;color:var(--accent);font-weight:700}
  .board-desc{font-size:13px;color:var(--muted);margin-top:4px}

  /* --- Thread List --- */
  .thread{background:#041804;padding:12px;border-radius:var(--radius);
          border:1px solid var(--border);margin-bottom:10px;cursor:pointer}
  .thread:hover{background:#082508}
  .thread .title{font-size:17px;font-weight:700;color:var(--accent)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}

  /* --- Thread Page --- */
  .post{background:#021401;border:1px solid #0a3f10;border-radius:var(--radius);
        margin-top:12px;padding:12px}
  .images img{max-width:150px;border-radius:8px;border:2px solid #07360b;margin-right:6px;margin-top:6px}

  input,textarea{width:100%;padding:8px;border-radius:8px;background:#001600;
                 border:1px solid #0a3f10;color:var(--text)}
  textarea{min-height:90px}

  .btn{width:100%;padding:10px;border-radius:8px;background:var(--accent);color:#002200;
       border:none;margin-top:8px;font-weight:700}

  /* --- Mobile Tabbar --- */
  .tabbar{
    position:fixed;bottom:0;left:0;right:0;height:60px;
    background:#123012;border-top:2px solid #072007;display:flex;z-index:999;
  }
  .tabbar button{flex:1;background:none;border:none;color:#d5ffd4;font-size:14px}

  /* Mobile */
  @media(max-width:700px){
    body{font-size:15px}
    .images img{max-width:80vw}
  }
</style>
</head>

<body>
<div class="wrap" id="page-boards">
  <header>
    <div class="logo">グロチャ民の掲示板</div>
  </header>

  <h2>板一覧</h2>
  <div id="board-list" class="board-list"></div>
</div>

<!-- ========== THREAD LIST PAGE ========== -->
<div class="wrap" id="page-threads" style="display:none">
  <a href="#" class="meta" onclick="backBoards()">← 板一覧へ</a>
  <h2 id="current-board-title"></h2>
  <div id="threads"></div>
</div>

<!-- ========== THREAD PAGE ========== -->
<div class="wrap" id="page-thread" style="display:none">
  <a href="#" class="meta" onclick="backThreadList()">← スレ一覧へ</a>
  <h2 id="thread-title"></h2>
  <div id="thread-posts"></div>

  <div class="post">
    <h3>レス投稿</h3>
    <form id="create-post">
      <label>名前</label>
      <input id="post-author" placeholder="名無し">
      <label>本文</label>
      <textarea id="post-body" required></textarea>
      <label>画像（任意）</label>
      <input id="post-image" type="file" accept="image/*">
      <button class="btn">投稿</button>
    </form>
  </div>
</div>

<!-- Mobile Tabbar -->
<div class="tabbar">
  <button onclick="window.scrollTo({top:0,behavior:'smooth'})">上</button>
  <button onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})">下</button>
  <button onclick="focusReply()">レス</button>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/*****************************************************
 * SUPABASE KEYS（差し替え必須）
 *****************************************************/
const SUPABASE_URL = "<<<https://spjepboucvocedgoxzwg.supabase.co>>>";
const SUPABASE_ANON_KEY = "<<<eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwamVwYm91Y3ZvY2VkZ294endnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTMwMDEsImV4cCI6MjA3OTU2OTAwMX0.nmDF_BRiaXxTV2ij2ak4Fg24iCfHkvAbL7zNDbKCKWU>>>";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = "thread-images";

/*****************************************************
 * セーフティ
 *****************************************************/
const NG = ["殺す","死ね","spam"];
const COOLTIME = 5000;
let lastPost = 0;

function esc(s){
  return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}

/*****************************************************
 * 板一覧読み込み
 *****************************************************/
async function loadBoards(){
  const {data} = await supabase.from("boards").select("*").order("id");
  const box = document.getElementById("board-list");
  box.innerHTML = "";

  data.forEach(b=>{
    const div = document.createElement("div");
    div.className="board-item";
    div.innerHTML = `
      <div class="board-title">${esc(b.label)}</div>
      <div class="board-desc">${esc(b.description||"")}</div>
    `;
    div.onclick = ()=> openBoard(b.key, b.label);
    box.appendChild(div);
  });
}

/*****************************************************
 * スレ一覧
 *****************************************************/
async function openBoard(key,label){
  window.currentBoard = key;
  document.getElementById("current-board-title").textContent = label;

  document.getElementById("page-boards").style.display="none";
  document.getElementById("page-threads").style.display="block";

  const {data} = await supabase
    .from("threads")
    .select("id,title,author,last_post_at,posts(count)")
    .eq("board", key)
    .order("last_post_at",{ascending:false});

  const box = document.getElementById("threads");
  box.innerHTML = "";

  data.forEach(t=>{
    const cnt = t.posts ? t.posts.length : 0;
    const div = document.createElement("div");
    div.className="thread";
    div.innerHTML = `
      <div class="title">${esc(t.title)}</div>
      <div class="meta">勢い: ${cnt} ／ ${esc(t.author)}</div>
    `;
    div.onclick = ()=> openThread(t.id);
    box.appendChild(div);
  });
}

function backBoards(){
  document.getElementById("page-boards").style.display="block";
  document.getElementById("page-threads").style.display="none";
}

/*****************************************************
 * スレ読み込み
 *****************************************************/
async function openThread(id){
  window.currentThread = id;

  document.getElementById("page-threads").style.display="none";
  document.getElementById("page-thread").style.display="block";

  const {data: thread} = await supabase
    .from("threads")
    .select("*, posts(*), images(*)")
    .eq("id", id).single();

  document.getElementById("thread-title").textContent = thread.title;

  const pbox = document.getElementById("thread-posts");
  pbox.innerHTML = "";

  const posts = thread.posts.sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  posts.forEach((p,i)=>{
    const d = document.createElement("div");
    d.className="post";

    let html = `
      <div class="meta"><b>#${i+1}</b> 名前: ${esc(p.author)} [ID:${p.id}]</div>
      <div style="margin-top:6px">${esc(p.body)}</div>
    `;

    if(p.image_url){
      html += `<div class="images"><img src="${p.image_url}"></div>`;
    }

    d.innerHTML = html;
    pbox.appendChild(d);
  });
}

function backThreadList(){
  document.getElementById("page-thread").style.display="none";
  document.getElementById("page-threads").style.display="block";
}

/*****************************************************
 * 画像圧縮
 *****************************************************/
function compressImage(file){
  return new Promise(res=>{
    const img = new Image();
    const r = new FileReader();
    r.onload = e=> img.src=e.target.result;
    img.onload = ()=>{
      const MAX = 1200;
      let w = img.width, h = img.height;
      if(w>MAX || h>MAX){
        if(w>h){ h = h*MAX/w; w = MAX; }
        else    { w = w*MAX/h; h = MAX; }
      }
      const c = document.createElement("canvas");
      c.width=w; c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      c.toBlob(b=>res(b),"image/jpeg",0.7);
    };
    r.readAsDataURL(file);
  });
}

/*****************************************************
 * レス投稿
 *****************************************************/
document.getElementById("create-post").addEventListener("submit", async e=>{
  e.preventDefault();

  const body = document.getElementById("post-body").value.trim();
  const author = document.getElementById("post-author").value.trim() || "名無し";
  const file = document.getElementById("post-image").files[0];

  if(!body) return alert("本文が必要");
  if(Date.now() - lastPost < COOLTIME) return alert("連投規制中");
  if(NG.some(w=>body.includes(w))) return alert("禁止ワード");

  let img_url=null;
  if(file){
    const blob = await compressImage(file);
    const key = `p_${window.currentThread}/${crypto.randomUUID()}.jpg`;
    await supabase.storage.from(BUCKET).upload(key, blob);
    img_url = supabase.storage.from(BUCKET).getPublicUrl(key).publicUrl;
  }

  await supabase.from("posts").insert([{
    thread_id: window.currentThread,
    author,
    body,
    image_url: img_url
  }]);

  document.getElementById("post-body").value="";
  document.getElementById("post-image").value=null;

  lastPost = Date.now();
  openThread(window.currentThread);
});

/*****************************************************
 * 初期
 *****************************************************/
loadBoards();

function focusReply(){
  const t = document.getElementById("post-body");
  t.scrollIntoView({behavior:"smooth"});
  t.focus();
}
</script>
</body>
</html>
